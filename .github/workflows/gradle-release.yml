name: Build and Release

on:
 push:
   tags:
     - '*'

jobs:
 build:
   runs-on: ubuntu-latest

   steps:
   - name: Checkout code
     uses: actions/checkout@v2

   - name: Set up JDK
     uses: actions/setup-java@v1
     with:
       java-version: 11

   - name: Grant execute permission for gradlew
     run: chmod +x gradlew

   - name: Build with Gradle
     run: ./gradlew clean pz

   - name: Archive production artifacts
     uses: actions/upload-artifact@v2
     with:
       name: pz
       path: build/distributions/*

 release:
   needs: build
   runs-on: ubuntu-latest

   steps:
   - name: Checkout code
     uses: actions/checkout@v2

   - name: Download artifacts
     uses: actions/download-artifact@v2
     with:
       name: pz

   - name: Create Release
     id: create_release
     uses: actions/create-release@v1
     env:
       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
     with:
       tag_name: ${{ github.ref }}
       release_name: Release ${{ github.ref }}
       draft: false
       prerelease: false

   - name: Upload Release Asset
     id: upload_release_asset
     uses: actions/upload-release-asset@v1
     env:
       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
     with:
       upload_url: ${{ steps.create_release.outputs.upload_url }}
       asset_path: ./pz
       asset_name: pz
       asset_content_type: application/zip
